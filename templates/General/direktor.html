<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../static/style/smallScreen.css">
    <link rel="stylesheet" href="../../static/style/fix-plan.css">
    <link rel="stylesheet" href="../../static/style/potrosnja_materiala_torta.css">
    <link rel="stylesheet" href="../../static/style/navigation.css">
    <link rel="stylesheet" href="../../static/style/potrosnja_materiala_grafi.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #prikazButton {
            margin-left: 15vw;
        }
        #form-container {
            margin-left: 15vw;
        }
        h1 {
            margin-left: 15vw;
        }
        #workerDF {
            display: flex;
            justify-content: space-between; /* To evenly distribute the sections */
        }

        .data-frame-section {
            width: 48%; /* Adjust the width as needed */
        }
    </style>
</head>
<body>
    <div class="content">
        <!-- fiksni_načrti -->
        <h1>Fiksni načrt</h1>
        <button id="prikazButton" onclick="switchDisplay(this)">Prikaz po tednih</button>
        <div id="form-container" style="display: none">
            <form id="weekRangeForm">
                <label for="startWeek">Od:</label>
                <input type="number" id="startWeek" name="startWeek" min="1" max="52">

                <label for="endWeek">Do:</label>
                <input type="number" id="endWeek" name="endWeek" min="1" max="52">

                <button type="submit">Prikaži</button>
            </form>
        </div>
        <canvas id="fiksniNacrtCanvas" class="graph-canvas"></canvas>
        <hr>

        <!-- potrosnja_materiala_torta -->
        <h1>Realizacija bruto/neto za periodo</h1>
        <br>
        <form id="date_form">
            <label for="from_date">Od:</label>
            <input type="date" id="from_date" name="from_date" value="2024-01-01">
            <label for="to_date">Do:</label>
            <input type="date" id="to_date" name="to_date" value="2024-12-31">
            <button type="button" onclick="fetchData()">Prikaži</button>
        </form>
        <canvas id="potrosnjaMaterialaTortaCanvas" class="graph-canvas"></canvas>
        <div id="legendPMT"></div>
        <form id="month_form">
            <label for="from_month">Od: </label>
            <input type="month" id="from_month" name="from_month">
            <label for="to_month">Do: </label>
            <input type="month" id="to_month" name="to_month">
            <button type="button" onclick="fetchMonthlyData()">Prikaži</button>
        </form>
        <canvas id="monthlyChartPMTCanvas" class="graph-canvas"></canvas>
        <hr>

        <!-- Produktivnost delavcev za periodo -->
        <h1>Produktivnost delavcev za periodo</h1>
        <form class="date_form">
            <label for="from_date_graf">Od:</label>
            <input type="month" id="from_date_graf" name="from_date" value="2024-01">
            <label for="to_date_graf">Do:</label>
            <input type="month" id="to_date_graf" name="to_date" value="2024-12">
            <button type="button" onclick="fetchProduktivnostData()">Prikaži</button>
        </form>
        <!-- Graph -->
        <canvas id="oddelkiProduktivnostChart" class="graph-canvas"></canvas>
        <form class="date_form">
            <label for="from_date_table">Tabela za obdobje od:</label>
            <input type="month" id="from_date_table" name="from_date_table">
            <label for="to_date_table">Do:</label>
            <input type="month" id="to_date_table" name="to_date_table">
            <button type="button" onclick="fetchDataTable()">Prikaži</button>
        </form>
        <br>
        <h2>Tabela produktivnosti za obdobje</h2>
        <div id="workerDF">
            <div id="top5" class="data-frame-section">
                <h3 style="color: #45a049">Najboljših 5 delavcev</h3>
                <div id="top5Table"></div>
            </div>
            <div id="bottom5" class="data-frame-section">
                <h3 style="color: red">Najslabših 5 delavcev</h3>
                <div id="bottom5Table"></div>
            </div>
        </div>
        <br>
        <form class="date_form">
            <label for="from_delavec_date_table">Grafi delavca od:</label>
            <input type="month" id="from_delavec_date_table" name="from_delavec_date_table">
            <label for="to_delavec_date_table">Do:</label>
            <input type="month" id="to_delavec_date_table" name="to_delavec_date_table">
        </form>
        <h2 id="workerChartTitle"></h2>
        <div>
            <canvas id="delavecChart" width="200" height="200"></canvas>
        </div>
        <br>
        <div id="container">
            <h1>Prikaz verzug liste</h1>
            <div id="sheets"></div>
            <div id="table-container"></div>
        </div>
    </div>
<script>

    //PLANIRANJE
    var comparisonChart;
    document.addEventListener("DOMContentLoaded", function() {
        setDefaultMonths();
        fetchData(); // Fetch data when the page loads initially
        loadData('month'); // Load initial data for weekly view
        fetchProduktivnostData(); // Fetch data when the page loads initially
        fetchDataTable();

    });
    function getWeekNumber(date) {
        var startDate = new Date(date.getFullYear(), 0, 1);
        var days = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
        return Math.ceil((days + startDate.getDay() + 1) / 7);
    }

    window.onload = function() {
        var currentDate = new Date();
        var startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        var endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        var startWeek = getWeekNumber(startOfMonth);
        var endWeek = getWeekNumber(endOfMonth);

        document.getElementById("startWeek").value = startWeek;
        document.getElementById("endWeek").value = endWeek;
    };

    function loadData(view, from, to) {
        fetch(`/direktorLoadGrafi?monthOrWeek=${view}&from=${from}&to=${to}`)
            .then(response => response.json())
            .then(data => {
                var ctx = document.getElementById('fiksniNacrtCanvas').getContext('2d');
                var chartData = {
                    labels: data.pl_kw_values,
                    datasets: [{
                        label: 'PLANIRANI IZNOS',
                        data: data.pl_iznos_values,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                    }, {
                        label: 'REALIZIRANI IZNOS',
                        data: data.real_iznos_values,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        stack: 'combined'
                    }, {
                        label: 'AVANS',
                        data: data.neki_iznos_values,
                        backgroundColor: 'rgb(255,234,0)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        stack: 'combined'
                    }]
                };

                if (comparisonChart) {
                    comparisonChart.destroy(); // Destroy the old chart instance
                }

                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        plugins: {
                            tooltip: {
                                titleFont: { // Set the font size for the tooltip header
                                    size: 18 // Adjust the font size as needed
                                },
                                bodyFont: { // Set the font size for the tooltip
                                    size: 18 // Adjust the font size as needed
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true // Enable stacking for the x-axis
                            },
                            y: {
                                stacked: true // Enable stacking for the y-axis
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    document.getElementById('fiksniNacrtCanvas').addEventListener('click', function(event) {
        var activePoints = comparisonChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);

        if (activePoints.length > 0) {
            var firstPoint = activePoints[0];
            var label = comparisonChart.data.labels[firstPoint.index];

            // Make AJAX request to Flask route
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_table_data_mj?label=' + label, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Parse the received JSON response
                        var htmlContent = xhr.responseText;
                        displayHTMLTableInNewTab(htmlContent);
                        // Open another HTML file in a new tab with URL parameters
                    } else {
                        // Handle error
                        console.error('Error:', xhr.statusText);
                    }
                }
            };
            xhr.send();
        }
    });

    function switchDisplay(button) {
        if (button.innerHTML === "Prikaz po tednih") {
            button.innerHTML = "Prikaz po mesecu";
            var currentDate = new Date();
            var startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            var endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            var startWeek = getWeekNumber(startOfMonth);
            var endWeek = getWeekNumber(endOfMonth);

            document.getElementById("startWeek").value = startWeek;
            document.getElementById("endWeek").value = endWeek;
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('weekRangeForm').addEventListener("submit", function(event) {
                event.preventDefault();
                var startWeek = document.getElementById("startWeek").value;
                var endWeek = document.getElementById("endWeek").value;
                loadData('week', startWeek, endWeek);
            });
            loadData('week');
        } else {
            button.innerHTML = "Prikaz po tednih";
            document.getElementById('form-container').style.display = 'none';
            loadData('month');
        }
    }


    //TORTA
    // Get today's date
	var monthlyChartPMTCanvas;
    var weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 8); // Set to week ago
    var yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1); // Set to yesterday
    // Format yesterday's date as 'YYYY-MM-DD' for input[type=date]

    var yyyy = weekAgo.getFullYear();
    var mm = String(weekAgo.getMonth() + 1).padStart(2, '0');
    var dd = String(weekAgo.getDate()).padStart(2, '0');
    var weekAgoFormatted = yyyy + '-' + mm + '-' + dd;

    // Get today's date
    var today = new Date();
    var startingDate = new Date();
    startingDate.setDate(1)

    // Check if today is Monday (0 index for Sunday, 1 for Monday, and so on)
    if (today.getDay() === 1) { // If today is Monday
        today.setDate(today.getDate() - 3); // Set to previous Friday
    } else {
        today.setDate(today.getDate() - 1); // Set to yesterday
    }

    // Format the date as 'YYYY-MM-DD' for input[type=date]
    var yyyy = today.getFullYear();
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var dd = String(today.getDate()).padStart(2, '0');
    var yesterdayFormated = yyyy + '-' + mm + '-' + dd;
    var yyyy = startingDate.getFullYear();
    var mm = String(startingDate.getMonth() + 1).padStart(2, '0');
    var dd = String(startingDate.getDate()).padStart(2, '0');
    var formattedStartingDate = yyyy + '-' + mm + '-' + dd;
    // console.log('Starting date:', formattedStartingDate)
    // console.log('Today:', yesterdayFormated)

    // Set the 'from_date' and 'to_date' input values to yesterday's date
    document.getElementById('from_date').value = weekAgoFormatted;
    document.getElementById('to_date').value = yesterdayFormated;


    function setDefaultMonths() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Adding 1 since getMonth() returns 0-11

        const fromMonth = `${year}-01`;
        const toMonth = `${year}-${month}`;

        document.getElementById('from_month').value = fromMonth;
        document.getElementById('to_month').value = toMonth;
        document.getElementById('from_date_graf').value = fromMonth;
        document.getElementById('to_date_graf').value = toMonth;
        document.getElementById('from_date_table').value = toMonth;
        document.getElementById('to_date_table').value = toMonth;
        document.getElementById('from_delavec_date_table').value = fromMonth;
        document.getElementById('to_delavec_date_table').value = toMonth;
        fetchMonthlyData();
    }

    window.onload = setDefaultMonths;

    var pieChart; // Declare the chart variable globally
    var oddelkiPChart; // Declare the chart variable globally
    var delavecChart; // Declare the chart variable globally

    function fetchData() {
        var from_date = document.getElementById('from_date').value;
        var to_date = document.getElementById('to_date').value;
        // console.log('From date TORTA:', from_date)
        // console.log('To date TORTA:', to_date)
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/potrošnja_materiala_grafi?from_date=' + from_date + '&to_date=' + to_date);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                displayPieChart(response);
            } else {
                console.error('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.send();
    }

    function displayPieChart(response) {
        var data = response.data;
        var groupedData = groupData(data);
        displayDataTable(tableData); // Call the function here
        var labels = Object.keys(groupedData);
        var values = Object.values(groupedData);
        var colors = ['red', 'yellow', 'green'];

        // Destroy the existing chart instance if it exists
        if (pieChart) {
            pieChart.destroy();
        }

        var ctx = document.getElementById('potrosnjaMaterialaTortaCanvas').getContext('2d');
        pieChart = new Chart(ctx, {
            type: 'pie', // Change the chart type to pie
            data: {
                labels: labels,
                datasets: [{
                    label: 'Bruto/Num',
                    data: values, // Use the values as they represent the sums
                    backgroundColor: colors, // Set colors
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        titleFont: { // Set the font size for the tooltip header
                            size: 18 // Adjust the font size as needed
                        },
                        bodyFont: { // Set the font size for the tooltip
                            size: 18 // Adjust the font size as needed
                        }
                    }
                }
            }
        });
    }

    var count = 0;
    var tableData = {
        '0-49': { count: 0, sum: 0, percentage: 0, color: 'red'},
        '50-70': { count: 0, sum: 0, percentage: 0, color: 'yellow'},
        '71-': { count: 0, sum: 0, percentage: 0, color: 'green'}
    };

    function groupData(data) {
        var groupedData = {
            '0-49': { count: 0, sum: 0},
            '50-70': { count: 0, sum: 0},
            '71-': { count: 0, sum: 0}
        };
        count = 0;
        tableData = {
            '0-49': { count: 0, sum: 0, percentage: 0, color: 'red'},
            '50-70': { count: 0, sum: 0, percentage: 0, color: 'yellow'},
            '71-': { count: 0, sum: 0, percentage: 0, color: 'green'}
        };

        data.forEach(function(row) {
            if (row.Postotak >= 0 && row.Postotak < 50) {
                count += row.Bruto;
                groupedData['0-49'].count++;
                groupedData['0-49'].sum += row.Bruto;
            } else if (row.Postotak >= 50 && row.Postotak < 70) {
                count += row.Bruto;
                groupedData['50-70'].count++;
                groupedData['50-70'].sum += row.Bruto;
            } else if (row.Postotak >= 71) {
                count += row.Bruto;
                groupedData['71-'].count++;
                groupedData['71-'].sum += row.Bruto;
            }
        });

        // Calculate averages
        for (var key in groupedData) {
            if (groupedData.hasOwnProperty(key)) {
                if (groupedData[key].count !== 0) {
                    tableData[key].count = groupedData[key].count;
                    tableData[key].sum = groupedData[key].sum ;
                    tableData[key].percentage = ((groupedData[key].sum / count) * 100).toFixed(2);
                    groupedData[key] = groupedData[key].sum;
                }
            }
        }

        return groupedData;
    }

    function displayDataTable(tableData) {
        var table = "<table><tr><th>Group</th><th>Average</th></tr>";
        for (var key in tableData) {
            if (tableData.hasOwnProperty(key)) {
                table += "<tr style='background-color: " + tableData[key].color + "'><td>" + key + "</td><td>" + tableData[key].percentage + "%</td></tr>";
            }
        }
        table += "</table>";

        // Display the table in a designated HTML element
        document.getElementById('monthlyChartPMTCanvas').innerHTML = table;
    }

    function fetchMonthlyData() {
        var from_selectedMonth = document.getElementById('from_month').value;
        var from_year = from_selectedMonth.split('-')[0];
        var from_month = from_selectedMonth.split('-')[1];
        var to_selectedMonth = document.getElementById('to_month').value;
        var to_year = to_selectedMonth.split('-')[0];
        var to_month = to_selectedMonth.split('-')[1];
        var from_firstDayOfMonth = new Date(from_year, from_month - 1, 2);
        var to_lastDayOfMonth = new Date(to_year, to_month, 1);
        var from_date = from_firstDayOfMonth.toISOString().split('T')[0];
        var to_date = to_lastDayOfMonth.toISOString().split('T')[0];
        // console.log('From date:', from_date)
        // console.log('To date:', to_date)
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/potrosnja_materiala_mj?from_date=' + from_date + '&to_date=' + to_date);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                displayChart(response);
                // console.log("Response: ", response);
            } else {
                console.error('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.send();
    }
    function displayChart(response) {
        const graphData = response.data;
        const labels = [...new Set(graphData.map(item => item.YearMonth))];
        const categories = [...new Set(graphData.map(item => item.kate))];

        const dataMap = {};
		if (monthlyChartPMTCanvas) {
            monthlyChartPMTCanvas.destroy();
        }
        graphData.forEach(item => {
            if (!dataMap[item.YearMonth]) {
                dataMap[item.YearMonth] = {};
            }
            dataMap[item.YearMonth][item.kate] = item.AveragePostotak;
        });

        const datasets = categories.map(category => {
            const data = labels.map(label => dataMap[label][category] || 0);
            const backgroundColors = labels.map((label, index) => {
                if (category === '0-49') {
                    return 'rgba(255, 0, 0, 0.2)'; // red
                } else if (category === '50-70') {
                    return 'rgba(255, 255, 0, 0.2)'; // yellow
                } else if (category === '>71') {
                    return 'rgba(0, 255, 0, 0.2)'; // green
                } else {
                    return 'rgba(0, 0, 0, 0.2)'; // default color for other categories
                }
            });
            const borderColors = labels.map((label, index) => {
                const value = data[index];
                if (category === 'Postotak') {
                    if (value >= 71) {
                        return 'rgba(0, 255, 0, 1)'; // green
                    } else if (value >= 50) {
                        return 'rgba(255, 255, 0, 1)'; // yellow
                    } else {
                        return 'rgba(255, 0, 0, 1)'; // red
                    }
                } else {
                    return 'rgba(0, 0, 0, 1)'; // default color for other categories
                }
            });
            return {
                label: category,
                data: data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            };
        });

        const ctx = document.getElementById('monthlyChartPMTCanvas').getContext('2d');
        monthlyChartPMTCanvas = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    tooltip: {
                        titleFont: { // Set the font size for the tooltip header
                            size: 18 // Adjust the font size as needed
                        },
                         bodyFont: { // Set the font size for the tooltip
                            size: 18 // Adjust the font size as needed
                        },
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + '%';
                                }
                                if (context.dataset.label === 'Postotak') {
                                    var dataPoint = data[context.dataIndex];
                                    label += '\nBruto: ' + dataPoint.Bruto;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }


    //PRODUKTIVNOST
    function fetchProduktivnostData() {
        var from_selectedMonth = document.getElementById('from_date_graf').value;
        var from_year = from_selectedMonth.split('-')[0];
        var from_month = from_selectedMonth.split('-')[1];
        var to_selectedMonth = document.getElementById('to_date_graf').value;
        // console.log('To date:', to_selectedMonth)
        var to_year = to_selectedMonth.split('-')[0];
        var to_month = to_selectedMonth.split('-')[1];
        var from_firstDayOfMonth = new Date(from_year, from_month - 1, 1);
        var to_lastDayOfMonth = new Date(to_year, to_month, 1);
        // console.log('From date:', from_firstDayOfMonth)
        var from_date = from_firstDayOfMonth.toISOString().split('T')[0];
        var to_date = to_lastDayOfMonth.toISOString().split('T')[0];

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/produktivnost_grafi_load?from_date=' + from_date + '&to_date=' + to_date);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                // console.log(response);
                displayOddelkiProduktivnostChart(response);
            } else {
                console.error('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.send();
    }

    function displayOddelkiProduktivnostChart(response) {
        if (oddelkiPChart) {
            oddelkiPChart.destroy();
        }
        // Render graph data
        const graphData = response.graph_data;
        const colors = response.colors;
        const labels = response.labels;

        // Prepare data for Chart.js
        const datasets = [];
        const places = Object.keys(colors);

        places.forEach(place => {
            const placeData = labels.map(label => graphData[label][place] || null);
            datasets.push({
                label: place,
                data: placeData,
                backgroundColor: colors[place],
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            });
        });

        // Create chart using Chart.js
        const ctx = document.getElementById('oddelkiProduktivnostChart').getContext('2d');
        oddelkiPChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                plugins: {
                    tooltip: {
                        titleFont: { // Set the font size for the tooltip header
                            size: 18 // Adjust the font size as needed
                        },
                        bodyFont: { // Set the font size for the tooltip
                            size: 18 // Adjust the font size as needed
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function fetchDataTable() {
        var from_selectedMonth = document.getElementById('from_date_table').value;
        var from_year = from_selectedMonth.split('-')[0];
        var from_month = from_selectedMonth.split('-')[1];
        var to_selectedMonth = document.getElementById('to_date_table').value;
        var to_year = to_selectedMonth.split('-')[0];
        var to_month = to_selectedMonth.split('-')[1];
        var from_firstDayOfMonth = new Date(from_year, from_month - 1, 1);
        var to_lastDayOfMonth = new Date(to_year, to_month, 1);
        var from_date = from_firstDayOfMonth.toISOString().split('T')[0];
        var to_date = to_lastDayOfMonth.toISOString().split('T')[0];
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/produktivnost_table_load?from_date=' + from_date + '&to_date=' + to_date);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                var top_five = response.table_data_top;
                var bottom_five = response.table_data_bottom;
                // console.log("TABLE" + top_five);
                // console.log("TABLE" + bottom_five);
                displayTable(top_five, 'top5Table');
                displayTable(bottom_five, 'bottom5Table');
                //displayDataFrame(response.df); // Pass the DataFrame JSON to displayDataFrame function
            } else {
                console.error('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.send();
    }

    function formatDate(dateString) {
        const months = [
            "Januar", "Februar", "Marec", "April", "Maj", "Junij",
            "Julij", "Avgust", "September", "Oktober", "November", "December"
        ];

        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = months[date.getMonth()];

        return year + " " + month;
    }

    function displayTable(data, tableId) {
        var tableHtml = '';
        console.log("TABLE", tableId)
        console.log("NEKJ", data)

        if (data.length === 0) {
            tableHtml = '<p>No info to show</p>';
        } else {
            // Create table headers
            tableHtml = '<table border="1">';
            tableHtml += '<tr>';
            for (var key in data[0]) {
                tableHtml += '<th>' + key + '</th>';
            }
            tableHtml += '</tr>';

            // Add table rows
            data.forEach(function(item) {
                tableHtml += '<tr>';
                for (var key in item) {
                    console.log("KEY", key.index)
                    // Check if the value is a date and format it if necessary
                    if (key === 'MJESEC_GODINA') {
                        tableHtml += '<td>' + formatDate(item[key]) + '</td>';
                    } else if (key === 'DELAVEC') {
                        tableHtml += '<td><button class="delavecButton" onclick="displayChartForPerson(\'' + item[key] + '\')">' + item[key] + '</button></td>';
                    } else {
                        tableHtml += '<td>' + item[key] + '</td>';
                    }
                }
                tableHtml += '</tr>';
            });

            // Close table
            tableHtml += '</table>';
        }

        // Display the table in the designated div
        document.getElementById(tableId).innerHTML = tableHtml;
    }

    function displayChartForPerson(delavecName) {
        document.getElementById('workerChartTitle').innerText = delavecName;
        var from_date = document.getElementById('from_delavec_date_table').value;
        var to_date = document.getElementById('to_delavec_date_table').value;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/produktivnost_grafi_delavec_load?from_date=' + from_date + '&to_date=' + to_date + '&delavec=' + delavecName);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                // console.log(response);

                // Extract data from the response
                var delavecPodatki = response.delavecPodatki;

                // Extract MJESEC_GODINA and average_produktivnost arrays
                var mjesecGodina = delavecPodatki.map(function(item) {
                    return formatDate(item.MJESEC_GODINA);
                });
                var average_produktivnost = delavecPodatki.map(function(item) {
                    return item.average_produktivnost;
                });

                if(delavecChart) {
                    delavecChart.destroy();
                }

                // Create a bar chart
                var ctx = document.getElementById('delavecChart').getContext('2d');
                delavecChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: mjesecGodina,
                        datasets: [{
                            label: 'Average Produktivnost',
                            data: average_produktivnost,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            tooltip: {
                                titleFont: { // Set the font size for the tooltip header
                                    size: 18 // Adjust the font size as needed
                                },
                                bodyFont: { // Set the font size for the tooltip
                                    size: 18 // Adjust the font size as needed
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

            } else {
                console.error('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.onerror = function() {
            console.error('Request error');
        };
        xhr.send();
        // console.log("Displaying chart for: " + delavecName);
    }


    fetch('/verzugsListaLoad')
        .then(response => response.json())
        .then(data => {
            const sheetNames = data.sheet_names;
            const sheetsData = data.data;

            const sheetsDiv = document.getElementById('sheets');
            const tableContainer = document.getElementById('table-container');

            sheetNames.forEach(sheetName => {
                if (sheetName === 'Kasni kupcu') {
                    const button = document.createElement('button');
                button.textContent = sheetName;
                console.log('Sheet name:', sheetName)
                button.addEventListener('click', () => {
                    const sheetData = sheetsData[sheetName];
                    const table = document.createElement('table');
                    table.classList.add('excel-table');
                    const thead = table.createTHead();
                    const headerRow = thead.insertRow();
                    sheetData[0].forEach(column => {
                        const th = document.createElement('th');
                        th.textContent = column;
                        headerRow.appendChild(th);
                    });
                    const tbody = table.createTBody();
                    sheetData.slice(1).forEach(rowData => {
                        const row = tbody.insertRow();
                        rowData.forEach((cellData, index) => {
                            const cell = row.insertCell();
                            if (sheetData[0][index] === 'Status') {
                                const statusClass = getStatusColorClass(cellData);
                                if (statusClass) {
                                    cell.classList.add(statusClass);
                                }
                            }
                            cell.textContent = cellData;
                        });
                    });
                    tableContainer.innerHTML = '';
                    tableContainer.appendChild(table);
                });
                sheetsDiv.appendChild(button);
                }
            });
        })
        .catch(error => console.error('Error:', error));

    function getStatusColorClass(status) {
        switch (status) {
            case 'J':
                return 'green';
            case 'K':
                return 'yellow';
            case 'L':
                return 'red';
            case 'I':
                return 'gray';
            default:
                return ''; // Return an empty string if status doesn't match any case
        }
    }
</script>
</body>
</html>
