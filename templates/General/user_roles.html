<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Roles</title>
    <link rel="stylesheet" href="../../static/style/user_roles.css">
    <style>
        .edit-column {
            background-color: #b6b6b6; /* Background color of floating header */
            position: sticky;
            right: 0;
            z-index: 0; /* Ensure it's above other cells */
        }
        .username-column {
            background-color: #b6b6b6; /* Background color of floating header */
            position: sticky;
            left: 0;
            z-index: 0; /* Ensure it's above other cells */
        }
    </style>
</head>
<body>
    <div>
        <h1>Upravljanje uporabnikov</h1>

        <h2>Uporabniki</h2>
        <label for="inputID_rn"></label><input type="text" id="inputID_rn" onkeyup="filterTable()" placeholder="Iskanje uporabniškega imena.." autocomplete="off">
        <div class="table-container">
            <table id="myTable">
                <thead>
                    <tr>
                        <th>Uporabniško ime</th>
                        <th>grafi</th>
                        <th>po_identu</th>
                        <th>torta</th>
                        <th>oee</th>
                        <th>planiranje_proizvodnje</th>
                        <th>normativi</th>
                        <th>verzug_lista</th>
                        <th>kapaciteta</th>
                        <th>izmene</th>
                        <th>evidenca_ur</th>
                        <th>upravljanje_uporabnikov</th>
                        <th>aktivni_nalogi</th>
                        <th>neaktivni_nalogi</th>
                        <th>mm2Alat</th>
                        <th>fix_plan</th>
                        <th>produktivnost</th>
                        <th>produktivnost_pozicije</th>
                        <th>top_user</th>
                        <th>direktor</th>
                        <th class="edit-column">Uredi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in data %}
                    <tr>
                        <td class="username-column">{{ user.Username }}</td>
                        {% for privilege in ['grafi', 'po_identu', 'torta','oee', 'planiranje_proizvodnje', 'normativi', 'verzug_lista', 'kapaciteta', 'izmene', 'evidenca_ur', 'upravljanje_uporabnikov', 'aktivni_nalogi', 'neaktivni_nalogi', 'mm2Alat', 'fix_plan','produktivnost', 'produktivnost_pozicije', 'top_user','direktor'] %}
                        <td><label for="{{ privilege }}"></label><input id="{{ privilege }}" type="checkbox" {% if user.Stranice is not none and privilege in user.Stranice %}checked{% endif %} disabled></td>
                        {% endfor %}
                        <td class="edit-column"><button class="edit-button" onclick="toggleEditMode(this.parentNode.parentNode)">Uredi</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>
<script>
        function toggleEditMode(row) {
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(function(checkbox) {
                checkbox.disabled = !checkbox.disabled;
            });

            const editButton = row.querySelector('.edit-button');
            if (editButton.innerHTML === 'Edit') {
                editButton.innerHTML = 'Submit';
            } else {
                editButton.innerHTML = 'Edit';
                // Handle submission of edited privileges (you can implement this)
                submitEditedPrivileges(row);
            }
        }

        function submitEditedPrivileges(row) {
            const username = row.cells[0].innerHTML; // Get the username from the first cell of the row
            const privileges = []; // Array to store selected privileges
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(function(checkbox) {
                if (checkbox.checked) {
                    privileges.push(checkbox.id); // Add the ID of the checked checkbox to the array
                }
            });

            // AJAX call to send data to the server
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/update_privileges');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log(xhr.responseText); // Log the response from the server
                    // You can add further handling here if needed
                } else {
                    console.error('Request failed. Status code: ' + xhr.status);
                }
            };
            xhr.onerror = function() {
                console.error('Request failed');
            };
            // Prepare data to send in JSON format
            const data = {
                username: username,
                privileges: privileges
            };
            xhr.send(JSON.stringify(data));
        }

        function filterTable() {
            let input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("inputID_rn");
            filter = input.value.toUpperCase();
            table = document.getElementById("myTable");
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0]; // Get the first column (ID_RN)
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = ""; // Display the row if ID_RN matches the filter
                    } else {
                        tr[i].style.display = "none"; // Hide the row if ID_RN does not match the filter
                    }
                }
            }
        }
    </script>
</html>
