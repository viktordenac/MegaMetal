<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../static/style/navigation.css">
    <title>Spremljanje delovnih ur</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 3fr;
            grid-gap: 10px;
            margin: 20px;
        }
        .sidebar {
            border: 1px solid #000;
            padding: 10px;
        }
        .main {
            border: 1px solid #000;
            padding: 10px;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }
        .calendar div {
            padding: 5px;
            border: 1px solid #000;
            cursor: pointer;
        }
        .calendar .header {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .time-table {
            width: 100%;
            border-collapse: collapse;
        }
        .time-table th, .time-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
        }
        .form-section {
            display: grid;
            grid-template-columns: 1fr 3fr;
            margin: 10px 0;
        }
        .form-section label {
            margin-right: 10px;
        }
        .form-section input, .form-section select {
            width: 100%;
        }
        .footer {
            display: grid;
            grid-template-columns: 1fr auto;
            margin-top: 20px;
        }
    </style>
    <script>
	function getSelectedKey() {
            const selectElement = document.getElementById('oj');
            return selectElement.value;
        }
	function createCalendar(month, year) {
		const calendar = document.getElementById('calendar');
		calendar.innerHTML = '';
		// Calculate days in the month and first day's weekday
		const daysInMonth = new Date(year, month, 0).getDate();
		const firstDay = new Date(year, month, 1).getDay();

		const dayNames = ['Ned', 'Pon', 'Tor', 'Sre', 'Čet', 'Pet', 'Sob'];

		// Create header row
		dayNames.forEach(day => {
			const dayDiv = document.createElement('div');
			dayDiv.classList.add('header');
			dayDiv.textContent = day;
			calendar.appendChild(dayDiv);
		});

		// Calculate the number of empty cells before the first day of the month
		for (let i = 0; i < firstDay; i++) {
			const emptyDiv = document.createElement('div');
			calendar.appendChild(emptyDiv);
		}

		// Create day cells for the entire month
		for (let day = 1; day <= daysInMonth; day++) {
			const dayDiv = document.createElement('div');
			dayDiv.textContent = day;
			dayDiv.onclick = function() {
				handleDayClick(year, month, day);
			};
			calendar.appendChild(dayDiv);
		}
	}

        function handleMonthClick(year, month) {
            // Format date as YYYY-MM-DD
			const selectedKey = getSelectedKey();
            const formattedDate = `${year}-${String(month+1).padStart(2, '0')}`;
            fetch(`/get_data_by_date?date=${formattedDate}&key=${selectedKey}`)
                .then(response => response.json())
                .then(data => updateTable(data))
                .catch(error => console.error('Error:', error));
        }
        function handleDayClick(year, month, day) {
            // Format date as YYYY-MM-DD
			const selectedKey = getSelectedKey();
            const formattedDate = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            fetch(`/get_data_by_date?date=${formattedDate}&key=${selectedKey}`)
                .then(response => response.json())
                .then(data => updateTable(data))
                .catch(error => console.error('Error:', error));
        }
		


        function updateTable(data) {
            const tbody = document.querySelector('.time-table tbody');
            tbody.innerHTML = '';
			let totalSeconds = 0;
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Day}</td>
                    <td>${row.Start}</td>
                    <td>${row.Worker}</td>
                    <td>${row.Oj}</td>
                    <td>${row.End}</td>
                    <td>${row.WorkedFor}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                `;
                tr.onclick = function() {
                    handleRowClick(row.USERNO);
                };
                tbody.appendChild(tr);
				        const [hours, minutes, seconds] = row.WorkedFor.split(':').map(Number);
						totalSeconds += hours * 3600 + minutes * 60 + seconds;
            });
const totalHours = Math.floor(totalSeconds / 3600);
    totalSeconds %= 3600;
    const totalMinutes = Math.floor(totalSeconds / 60);
    const totalFormatted = `${totalHours}:${totalMinutes.toString().padStart(2, '0')}`;

    // Create a row for the total sum
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="4">Total</td>
        <td>${totalFormatted}</td>
        <td colspan="4"></td>
    `;
    tbody.appendChild(totalRow);
        }

        function handleRowClick(id) {
            fetch(`/get_data_by_id?id=${id}`)
                .then(response => response.json())
                .then(data => updateForm(data))
                .catch(error => console.error('Error:', error));
        }

        function updateForm(data) {
            if (data.length > 0) {
                const row = data[0];
                document.getElementById('vp').value = row.Vp;
                document.getElementById('sati').value = row.Sati;
                document.getElementById('nalog').value = row.Nalog;
                document.getElementById('oj').value = row.OJ;
                document.getElementById('opis_posla').value = row['Opis posla'];
            }
        }

        function updateCalendar() {
            const monthSelect = document.getElementById('month');
            const yearSelect = document.getElementById('year');
            const month = monthSelect.selectedIndex;
            const year = yearSelect.value;
            createCalendar(month, year);
			handleMonthClick(year, month);
        }

        window.onload = function() {
            const currentDate = new Date();
            const monthSelect = document.getElementById('month');
            const yearSelect = document.getElementById('year');
            monthSelect.selectedIndex = currentDate.getMonth();
            yearSelect.value = currentDate.getFullYear();
            updateCalendar();
        };

		
		
    </script>
</head>
<body>
    {% include 'navigation.html' %}

    <div class="content">
        <div class="container">
            <div class="sidebar">
                <div class="form-section">
                <label for="oj">Naziv</label>
                    <select id="oj" name="oj" onchange="updateCalendar()">
                        {% for value, label in options %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-section">
                    <label for="month">Mesec</label>
                    <select id="month" name="month" onchange="updateCalendar()">
                        <option value="1">Januar</option>
                        <option value="2">Februar</option>
                        <option value="3">Marec</option>
                        <option value="4">April</option>
                        <option value="5">Maj</option>
                        <option value="6">Junij</option>
                        <option value="7">Julij</option>
                        <option value="8">Avgust</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="form-section">
                    <label for="year">Leto</label>
                    <select id="year" name="year" onchange="updateCalendar()">
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div id="calendar" class="calendar"></div>
            </div>
            <div class="main">
                <table class="time-table">
                    <thead>
                        <tr>
                            <th>Dan</th>
                            <th>Prihod</th>
                            <th>Ime in priimek</th>
                            <th>Oddelek</th>
                            <th>Odhod</th>
                            <th>Čas</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>