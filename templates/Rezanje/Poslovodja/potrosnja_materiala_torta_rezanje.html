<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizacija bruto/neto za period</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../../static/style/navigation.css">
    <style>
        /* Adjust chart container size */
        #myChart {
            width: 100%;
            max-height: 780px;
            margin: 0 auto; /* Center the container */
        }

        /* Adjust canvas size */
        canvas {
            max-width: 100%; /* Ensure canvas doesn't overflow its container */
            height: auto; /* Maintain canvas aspect ratio */
        }
    </style>
</head>
<body>
    <!-- Include the navigation bar using JavaScript -->
    {% include '/Rezanje/Poslovodja/rezPoslovodjaNavigation.html' %}

    <!-- Main content -->
    <div class="content">
        <h1>Realizacija bruto/neto za period</h1>
        <form id="date_form">
            <label for="from_date">From:</label>
            <input type="date" id="from_date" name="from_date" value="2024-01-01">
            <label for="to_date">To:</label>
            <input type="date" id="to_date" name="to_date" value="2024-12-31">
            <button type="button" onclick="fetchData()">Select Dates</button>
        </form>
        <canvas id="myChart"></canvas>
    </div>

<script>
    // Get today's date
    var weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7); // Set to week ago
    var yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1); // Set to yesterday
    // Format yesterday's date as 'YYYY-MM-DD' for input[type=date]

    var yyyy = weekAgo.getFullYear();
    var mm = String(weekAgo.getMonth() + 1).padStart(2, '0');
    var dd = String(weekAgo.getDate()).padStart(2, '0');
    var weekAgoFormatted = yyyy + '-' + mm + '-' + dd;

    var yyyy1 = yesterday.getFullYear();
    var mm1 = String(yesterday.getMonth() + 1).padStart(2, '0');
    var dd1 = String(yesterday.getDate()).padStart(2, '0');
    var yesterdayFormatted = yyyy1 + '-' + mm1 + '-' + dd1;

    // Set the 'from_date' and 'to_date' input values to yesterday's date
    document.getElementById('from_date').value = weekAgoFormatted;
    document.getElementById('to_date').value = yesterdayFormatted;

    fetchData(); // Fetch data when the page loads initially

    var myChart; // Declare the chart variable globally

    function fetchData() {
        var from_date = document.getElementById('from_date').value;
        var to_date = document.getElementById('to_date').value;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/PotroÅ¡nja-materiala-grafi?from_date=' + from_date + '&to_date=' + to_date);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                displayChart(response);
            } else {
                console.error('Request failed. Status: ' + xhr.status);
            }
        };
        xhr.send();
    }

    function displayChart(response) {
        var data = response.data;
        var groupedData = groupData(data);
        var labels = Object.keys(groupedData);
        var values = Object.values(groupedData);
        var colors = ['red', 'yellow', 'green', 'orange'];

        // Destroy the existing chart instance if it exists
        if (myChart) {
            myChart.destroy();
        }

        var ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'pie', // Change the chart type to pie
            data: {
                labels: labels,
                datasets: [{
                    label: 'Postotak',
                    data: values,
                    backgroundColor: colors, // Set colors
                    borderWidth: 1
                }]
            }
        });
    }

    function groupData(data) {
        var groupedData = {
            '0-49': 0,
            '50-74': 0,
            '75-99': 0,
            '100-': 0
        };

        data.forEach(function(row) {
            if (row.Postotak >= 0 && row.Postotak < 50) {
                groupedData['0-49']++;
            } else if (row.Postotak >= 50 && row.Postotak < 75) {
                groupedData['50-74']++;
            } else if (row.Postotak >= 75 && row.Postotak < 100) {
                groupedData['75-99']++;
            } else if (row.Postotak == 100) {
                groupedData['100-']++;
            }
        });

        return groupedData;
    }

</script>
</body>
</html>
